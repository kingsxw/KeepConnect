name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-mac-arm64:
    name: Build macOS ARM64
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Clean dist directory
        run: rm -rf dist || true
      
      - name: Check project structure
        run: |
          echo "Current directory:"
          pwd
          echo "Project structure:"
          ls -la
          echo "Checking for required files:"
          ls -la main.js package.json index.html renderer.js || true
      
      - name: Build macOS ARM64 (Unsigned)
        run: |
          # 使用明确的配置构建
          echo "Building macOS ARM64 without code signing..."
          
          # 创建临时配置文件，确保路径正确
          cat > electron-builder-config.yml << EOF
          appId: com.keepconnect.app
          productName: KeepConnect
          directories:
            output: dist
            app: .
          files:
            - "main.js"
            - "index.html"
            - "renderer.js"
            - "icon-256x256.png"
            - "icon-16x16.png"
            - "icon-1024x1024.png"
          mac:
            category: public.app-category.utilities
            icon: icon-1024x1024.png
            target: 
              - dmg
            identity: null
            hardenedRuntime: false
            gatekeeperAssess: false
          EOF
          
          # 使用配置文件构建
          npx electron-builder --mac --arm64 --config electron-builder-config.yml
      
      - name: Check build output
        run: |
          echo "Checking build output..."
          find . -name "*.dmg" -type f | xargs -I {} echo "Found: {}"
          
          if [ -d "dist" ]; then
            echo "Contents of dist directory:"
            ls -la dist/
            find dist -type f
          fi
      
      - name: Upload macOS ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: KeepConnect-macOS-ARM64
          path: |
            dist/*.dmg
            dist/**/*.dmg
          if-no-files-found: error

  build-mac-x64:
    name: Build macOS x64
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Clean dist directory
        run: rm -rf dist || true
      
      - name: Build macOS x64 (Unsigned)
        run: |
          # 使用明确的配置构建
          echo "Building macOS x64 without code signing..."
          
          # 创建临时配置文件，确保路径正确
          cat > electron-builder-config.yml << EOF
          appId: com.keepconnect.app
          productName: KeepConnect
          directories:
            output: dist
            app: .
          files:
            - "main.js"
            - "index.html"
            - "renderer.js"
            - "icon-256x256.png"
            - "icon-16x16.png"
            - "icon-1024x1024.png"
          mac:
            category: public.app-category.utilities
            icon: icon-1024x1024.png
            target: 
              - dmg
            identity: null
            hardenedRuntime: false
            gatekeeperAssess: false
          EOF
          
          # 使用配置文件构建
          npx electron-builder --mac --x64 --config electron-builder-config.yml
      
      - name: Upload macOS x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: KeepConnect-macOS-x64
          path: |
            dist/*.dmg
            dist/**/*.dmg
          if-no-files-found: error

  build-win-x64:
    name: Build Windows x64
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Clean dist directory
        run: |
          # 修复：在 Windows 上使用正确的命令清理目录
          if [ -d "dist" ]; then
            rm -rf dist
          fi
        shell: bash
      
      - name: Build Windows x64 Portable
        run: npm run build:win:x64:portable
      
      - name: Upload Windows x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: KeepConnect-Windows-x64
          path: dist/*.exe
          if-no-files-found: error

  build-win-x86:
    name: Build Windows x86
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4git 
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Clean dist directory
        run: |
          # 修复：在 Windows 上使用正确的命令清理目录
          if [ -d "dist" ]; then
            rm -rf dist
          fi
        shell: bash
      
      - name: Build Windows x86 Portable
        run: npm run build:win:x86:portable
      
      - name: Upload Windows x86 artifact
        uses: actions/upload-artifact@v4
        with:
          name: KeepConnect-Windows-x86
          path: dist/*.exe
          if-no-files-found: error

  build-linux-x64:
    name: Build Linux x64
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Clean dist directory
        run: rm -rf dist || true
      
      - name: Install required packages for Linux build
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot rpm
      
      - name: Build Linux x64
        run: npm run build:linux:x64
        env:
          # 设置 GitHub Token 用于构建过程
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 确保 electron-builder 能访问 GitHub
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Linux x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: KeepConnect-Linux-x64
          path: |
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
          if-no-files-found: error

  build-linux-ia32:
    name: Build Linux x86
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Clean dist directory
        run: rm -rf dist || true
      
      - name: Install required packages for Linux build
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot rpm
      
      - name: Build Linux x86
        run: npm run build:linux:ia32
        env:
          # 设置 GitHub Token 用于构建过程
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 确保 electron-builder 能访问 GitHub
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Linux x86 artifact
        uses: actions/upload-artifact@v4
        with:
          name: KeepConnect-Linux-x86
          path: |
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
          if-no-files-found: error

  build-linux-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Clean dist directory
        run: rm -rf dist || true
      
      - name: Install required packages for Linux build
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot rpm
      
      - name: Build Linux ARM64
        run: npm run build:linux:arm64
        env:
          # 设置 GitHub Token 用于构建过程
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 确保 electron-builder 能访问 GitHub
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Linux ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: KeepConnect-Linux-ARM64
          path: |
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
          if-no-files-found: error

  build-linux-armv7l:
    name: Build Linux ARMv7
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Clean dist directory
        run: rm -rf dist || true
      
      - name: Install required packages for Linux build
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot rpm
      
      - name: Build Linux ARMv7
        run: npm run build:linux:armv7l
        env:
          # 设置 GitHub Token 用于构建过程
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 确保 electron-builder 能访问 GitHub
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Linux ARMv7 artifact
        uses: actions/upload-artifact@v4
        with:
          name: KeepConnect-Linux-ARMv7
          path: |
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
          if-no-files-found: error

  create-release:
    name: Create Release
    needs: 
      - build-mac-arm64
      - build-mac-x64
      - build-win-x64
      - build-win-x86
      - build-linux-x64
      - build-linux-ia32
      - build-linux-arm64
      - build-linux-armv7l
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: Prepare release files
        run: |
          echo "Preparing release files..."
          mkdir -p release_files
          
          # 复制所有文件到release_files目录
          find artifacts -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" \) -exec cp {} release_files/ \;
          
          # 重命名文件以便识别
          cd release_files
          for file in *; do
            if [[ "$file" == *"mac-arm64"* ]]; then
              mv "$file" "KeepConnect-macOS-ARM64.dmg"
            elif [[ "$file" == *"mac-x64"* ]]; then
              mv "$file" "KeepConnect-macOS-x64.dmg"
            elif [[ "$file" == *"win-x64"* ]]; then
              mv "$file" "KeepConnect-Windows-x64.exe"
            elif [[ "$file" == *"win-x86"* ]]; then
              mv "$file" "KeepConnect-Windows-x86.exe"
            elif [[ "$file" == *"linux-x64"* && "$file" == *".AppImage" ]]; then
              mv "$file" "KeepConnect-Linux-x64.AppImage"
            elif [[ "$file" == *"linux-x86"* && "$file" == *".AppImage" ]]; then
              mv "$file" "KeepConnect-Linux-x86.AppImage"
            elif [[ "$file" == *"linux-arm64"* && "$file" == *".AppImage" ]]; then
              mv "$file" "KeepConnect-Linux-ARM64.AppImage"
            elif [[ "$file" == *"linux-armv7"* && "$file" == *".AppImage" ]]; then
              mv "$file" "KeepConnect-Linux-ARMv7.AppImage"
            elif [[ "$file" == *"linux-x64"* && "$file" == *".deb" ]]; then
              mv "$file" "KeepConnect-Linux-x64.deb"
            elif [[ "$file" == *"linux-x64"* && "$file" == *".rpm" ]]; then
              mv "$file" "KeepConnect-Linux-x64.rpm"
            fi
          done
          
          echo "Files to be released:"
          ls -la
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## Release ${{ github.ref_name }}
            
            ### Important Notes
            - **macOS builds are unsigned**: You may need to right-click and select "Open" to bypass Gatekeeper security
            - **Windows builds are portable executables**: No installation required
            - **Linux AppImages**: Make executable with `chmod +x filename.AppImage`
            
            ### Downloads
            
            **macOS:**
            - [KeepConnect-macOS-ARM64.dmg](KeepConnect-macOS-ARM64.dmg) - Apple Silicon (M1/M2/M3)
            - [KeepConnect-macOS-x64.dmg](KeepConnect-macOS-x64.dmg) - Intel Mac
            
            **Windows:**
            - [KeepConnect-Windows-x64.exe](KeepConnect-Windows-x64.exe) - 64-bit Portable
            - [KeepConnect-Windows-x86.exe](KeepConnect-Windows-x86.exe) - 32-bit Portable
            
            **Linux:**
            - [KeepConnect-Linux-x64.AppImage](KeepConnect-Linux-x64.AppImage) - 64-bit AppImage
            - [KeepConnect-Linux-x86.AppImage](KeepConnect-Linux-x86.AppImage) - 32-bit AppImage
            - [KeepConnect-Linux-ARM64.AppImage](KeepConnect-Linux-ARM64.AppImage) - ARM64 AppImage
            - [KeepConnect-Linux-ARMv7.AppImage](KeepConnect-Linux-ARMv7.AppImage) - ARMv7 AppImage
            - [KeepConnect-Linux-x64.deb](KeepConnect-Linux-x64.deb) - Debian/Ubuntu 64-bit
            - [KeepConnect-Linux-x64.rpm](KeepConnect-Linux-x64.rpm) - Fedora/RHEL 64-bit
            
            ### Installation Instructions
            1. **macOS**: Download the .dmg file, open it, and drag the app to Applications folder
            2. **Windows**: Download the .exe file and run directly (portable)
            3. **Linux**: Download the AppImage, make executable (`chmod +x filename.AppImage`), and run
            
            ### Support
            If you encounter any issues, please check the [GitHub repository](https://github.com/${{ github.repository }}) for documentation and support.
          draft: false
          prerelease: false
          files: release_files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}